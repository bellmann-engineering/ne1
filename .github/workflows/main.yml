  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - compiler: gcc
            cxx: "ccache g++"
            output: main
          - compiler: mingw
            cxx: "x86_64-w64-mingw32-g++"
            output: main.exe

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ matrix.compiler }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ matrix.compiler }}-

      - name: Install compilers and tools
        run: |
          sudo apt-get update
          sudo apt-get install -y g++ cmake libgtest-dev ccache
          if [ "${{ matrix.compiler }}" = "mingw" ]; then
            sudo apt-get install -y mingw-w64
          fi

          sudo cmake -S /usr/src/gtest -B /usr/src/gtest/build
          sudo cmake --build /usr/src/gtest/build
          sudo cp /usr/src/gtest/build/lib/*.a /usr/lib

      - name: Build main binary
        run: |
          ${{ matrix.cxx }} main.cpp -o ${{ matrix.output }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: main-${{ matrix.compiler }}
          path: ${{ matrix.output }}
